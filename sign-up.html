<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CitraChat - Sign Up</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" href="assets/logo.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
</head>
<body>
    <div class="container">
        <h2>Sign Up</h2>
        <form id="register-form">
            <input type="text" id="username" placeholder="Username" required>
            <span id="username-error" class="error-message"></span>
            
            <input type="email" id="email" placeholder="Email" required>
            <span id="email-error" class="error-message"></span>
            
            <input type="password" id="password" placeholder="Create a password" required>
            <span id="password-error" class="error-message"></span>
            
            <input type="password" id="confirm-password" placeholder="Confirm password" required>
            <span id="confirm-password-error" class="error-message"></span>
            
            <label for="profile-picture">Profile Picture (Optional)</label>
            <input type="file" id="profile-picture" accept="image/*">
            <div>
                <img id="profile-preview" style="display: none; max-width: 100%; margin-top: 10px;">
            </div>
            <button type="button" id="crop-button" style="display: none;">Crop Image</button>
            
            <button type="submit">Sign Up</button>
        </form>
        <p>Or Sign Up with</p>
        <button id="google-register" class="google-btn">
            <svg fill="#1C2033" width="24" height="24" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <path d="M61.5016 29.2001H32.8016V37.7001H53.4016C52.3016 49.5001 42.7016 54.6001 33.4016 54.6001C21.6016 54.6001 11.1016 45.4001 11.1016 32.1001C11.1016 19.3001 21.1016 9.60011 33.4016 9.60011C42.8016 9.60011 48.5016 15.7001 48.5016 15.7001L54.3016 9.60011C54.3016 9.60011 46.5016 1.10011 33.0016 1.10011C15.2016 1.00011 1.60156 15.9001 1.60156 32.0001C1.60156 47.6001 14.4016 63.0001 33.3016 63.0001C50.0016 63.0001 62.0016 51.7001 62.0016 34.8001C62.1016 31.3001 61.5016 29.2001 61.5016 29.2001Z"/>
            </svg>
            <span>Google</span>
        </button>
        <p>Already have an account? <a href="sign-in.html">Sign in</a></p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, sendEmailVerification, updateProfile, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
        import { z } from 'https://cdn.jsdelivr.net/npm/zod@3.22.2/lib/index.mjs'; // Impor Zod

        const firebaseConfig = {
            apiKey: "AIzaSyDThhuBYsoan2OrlorB6biO3SOb-CzI9wo",
            authDomain: "mediaapp-5c23d.firebaseapp.com",
            projectId: "mediaapp-5c23d",
            storageBucket: "mediaapp-5c23d.appspot.com",
            messagingSenderId: "180785458635",
            appId: "1:180785458635:web:b0547aba8a872453989a4e",
            measurementId: "G-L11KH85FD9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const googleProvider = new GoogleAuthProvider();

        // Mendefinisikan skema Zod untuk validasi
        const userSchema = z.object({
            username: z.string().min(3, "Username must be at least 3 characters long."),
            email: z.string().email("Invalid email address."),
            password: z.string().min(6, "Password must be at least 6 characters long"),
            confirmPassword: z.string().min(6, "Password must be at least 6 characters long.")
        });

        let cropper;

        document.getElementById('register-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Reset error messages
            document.getElementById('username-error').textContent = "";
            document.getElementById('email-error').textContent = "";
            document.getElementById('password-error').textContent = "";
            document.getElementById('confirm-password-error').textContent = "";

            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const profilePicture = document.getElementById('profile-picture').files[0];

            // Validasi data menggunakan Zod
            try {
                userSchema.parse({ username, email, password, confirmPassword });

                if (password !== confirmPassword) {
                    document.getElementById('confirm-password-error').textContent = "Passwords do not match.";
                    return;
                }

                const usersRef = collection(db, 'users');
                const q = query(usersRef, where("username", "==", username));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    document.getElementById('username-error').textContent = "Username already exists. Please choose another one.";
                    return;
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                let profileURL = `https://ui-avatars.com/api/?name=${username.charAt(0)}&background=random&size=128`;

                // Upload cropped image if available
                if (profilePicture) {
                    const croppedCanvas = cropper.getCroppedCanvas();
                    croppedCanvas.toBlob(async (blob) => {
                        const file = new File([blob], "cropped-profile-picture.png", { type: "image/png" });
                        const storageRef = ref(storage, `profilePictures/${user.uid}`);
                        await uploadBytes(storageRef, file);
                        profileURL = await getDownloadURL(storageRef);

                        // Update user profile
                        await updateProfile(user, {
                            displayName: username,
                            photoURL: profileURL
                        });

                        // Add user data to Firestore
                        await addDoc(usersRef, {
                            uid: user.uid,
                            username: username,
                            email: email,
                            profileURL: profileURL
                        });

                        await sendEmailVerification(user);
                        alert("Registration successful! Please check your email to verify your account.");
                        window.location.href = "sign-in.html";
                    });
                } else {
                    // Update user profile without image
                    await updateProfile(user, {
                        displayName: username,
                        photoURL: profileURL
                    });

                    // Add user data to Firestore
                    await addDoc(usersRef, {
                        uid: user.uid,
                        username: username,
                        email: email,
                        profileURL: profileURL
                    });

                    await sendEmailVerification(user);
                    alert("Registration successful! Please check your email to verify your account.");
                    window.location.href = "sign-in.html";
                }

            } catch (error) {
                if (error.errors) {
                    error.errors.forEach(err => {
                        const field = err.path[0];
                        document.getElementById(`${field}-error`).textContent = err.message;
                    });
                }
            }
        });

        document.getElementById('profile-picture').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const image = event.target.result;
                    const imageElement = document.createElement('img');
                    imageElement.src = image;

                    // Inisialisasi Cropper.js
                    const previewImage = document.createElement('img');
                    previewImage.src = image;
                    document.getElementById('profile-preview').style.display = 'block';
                    document.getElementById('profile-preview').src = image;

                    // Reset cropper jika sudah ada
                    if (cropper) {
                        cropper.destroy();
                    }

                    cropper = new Cropper(previewImage, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 1,
                    });

                    // Tampilkan tombol crop
                    document.getElementById('crop-button').style.display = 'block';
                };
                reader.readAsDataURL(files[0]);
            }
        });

        document.getElementById('crop-button').addEventListener('click', () => {
            if (cropper) {
                cropper.getCroppedCanvas().toBlob(async (blob) => {
                    if (blob) {
                        const file = new File([blob], "cropped-profile-picture.png", { type: "image/png" });
                        console.log('Cropped image file:', file);

                        // Tampilkan gambar yang telah di-crop
                        const croppedImageUrl = URL.createObjectURL(file);
                        const profilePreview = document.getElementById('profile-preview');
                        profilePreview.src = croppedImageUrl; // Update preview dengan gambar cropped
                    } else {
                        console.error("Failed to create blob from cropped canvas.");
                    }
                });
            }
        });

        document.getElementById('google-register').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const user = result.user;

                const profileURL = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName}&background=random&size=128`;
                
                // Tambahkan pengguna ke Firestore
                const usersRef = collection(db, 'users');
                await addDoc(usersRef, {
                    uid: user.uid,
                    username: user.displayName,
                    email: user.email,
                    profileURL: profileURL
                });

                alert("Registration successful!");
                window.location.href = "sign-in.html";
            } catch (error) {
                console.error("Error during Google sign-in:", error);
            }
        });
    </script>
</body>
</html>
